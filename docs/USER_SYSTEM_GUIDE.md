# 用户系统使用指南

## 概述

系统已实现用户认证和权限管理功能，支持管理员和普通用户两种角色。

## 功能特性

- ✅ 用户登录/登出
- ✅ 角色权限控制（管理员/普通用户）
- ✅ 管理员可访问设置功能
- ✅ 普通用户只能使用生成功能
- ✅ 登录状态持久化（localStorage）

## 数据库设置

### 1. 创建用户表

在 Supabase SQL Editor 中执行：

```sql
-- 执行 sql/users-schema.sql
```

### 2. 初始化用户账号

在 Supabase SQL Editor 中执行：

```sql
-- 执行 sql/init-users.sql
```

### 3. 默认账号

系统初始化后会创建两个默认账号：

**管理员账号：**
- 用户名：`admin`
- 密码：`admin123`
- 权限：可以访问所有功能，包括设置

**普通用户账号：**
- 用户名：`user`
- 密码：`user123`
- 权限：只能使用生成功能，不能访问设置

⚠️ **重要提示：** 在生产环境中，请务必修改这些默认密码！

## 使用方法

### 登录

1. 打开应用后，会自动显示登录界面
2. 输入用户名和密码
3. 点击"登录"按钮或按 Enter 键

### 登出

1. 点击右上角的用户信息区域
2. 点击登出图标
3. 确认登出

### 权限说明

**管理员（admin）：**
- ✅ 可以生成权益函
- ✅ 可以访问和修改系统设置
- ✅ 可以上传 Logo 和印章

**普通用户（user）：**
- ✅ 可以生成权益函
- ❌ 不能访问系统设置
- ❌ 不能修改配置

## 修改密码

### 方法 1：使用脚本生成新密码哈希

```bash
# 生成新密码的哈希值
tsx scripts/generate-password-hash.ts <新密码>
```

### 方法 2：在 Supabase 中直接更新

```sql
-- 更新用户密码（需要先使用脚本生成哈希值）
UPDATE users 
SET password_hash = '<新密码的SHA-256哈希值>'
WHERE username = 'admin';
```

## 添加新用户

### 使用 SQL 添加

```sql
-- 1. 生成密码哈希（使用脚本）
-- tsx scripts/generate-password-hash.ts <密码>

-- 2. 插入新用户
INSERT INTO users (username, password_hash, role, display_name) 
VALUES (
    '新用户名',
    '密码的SHA-256哈希值',
    'user',  -- 或 'admin'
    '显示名称'
);
```

## 技术实现

### 密码加密

- 使用 SHA-256 算法进行密码哈希
- 密码以哈希形式存储在数据库中
- 登录时在客户端进行哈希验证

### 认证流程

1. 用户输入用户名和密码
2. 系统查询用户表获取用户信息
3. 对输入的密码进行 SHA-256 哈希
4. 比较哈希值与数据库中的值
5. 验证成功后保存用户信息到 localStorage
6. 根据用户角色显示相应的功能

### 权限控制

- 使用 Vue 的 `computed` 属性动态控制 UI 显示
- 设置按钮仅对管理员可见
- 所有权限检查都在客户端进行

## 安全建议

1. **修改默认密码**：生产环境必须修改默认密码
2. **使用强密码**：建议使用包含大小写字母、数字和特殊字符的密码
3. **定期更新密码**：建议定期更换密码
4. **限制用户数量**：只创建必要的用户账号
5. **监控登录活动**：定期检查 `last_login_at` 字段

## 故障排除

### 无法登录

1. 检查用户名和密码是否正确
2. 确认用户表已创建
3. 确认用户账号已初始化
4. 检查浏览器控制台是否有错误信息

### 权限不正确

1. 检查用户表中的 `role` 字段
2. 确认用户已正确登录
3. 刷新页面重新加载用户信息

### 密码哈希不匹配

1. 确认使用 SHA-256 算法生成哈希
2. 检查数据库中存储的哈希值格式
3. 使用脚本重新生成密码哈希

## 相关文件

- `sql/users-schema.sql` - 用户表结构
- `sql/init-users.sql` - 初始化用户数据
- `src/lib/supabase-auth.ts` - 认证模块
- `scripts/generate-password-hash.ts` - 密码哈希生成工具

